# Copyright (c) 2025 ADBC Drivers Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: PR Validation

on:
  pull_request_target:
    types:
      - opened
      - edited
      - synchronize
    paths:
      - 'ci/scripts/**'
      - 'csharp/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title follows Conventional Commits
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Configure types based on Conventional Commits
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          # Require scope to be present (e.g., feat(csharp): add feature)
          requireScope: true
          # Define allowed scopes
          scopes: |
            csharp
            ci
            docs
          # Validate subject case (start with lowercase)
          subjectPattern: ^[a-z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            doesn't match the configured pattern. Please ensure that the subject
            starts with a lowercase letter.

  validate-description:
    name: Validate PR Description
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description has issue reference
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Check if PR description contains "Closes #" or "Fixes #" followed by a number
            const issueRefPattern = /(closes|fixes|resolves)\s+#\d+/i;

            if (!issueRefPattern.test(body)) {
              core.warning(
                'PR description should contain "Closes #NNN" or "Fixes #NNN" to link to an issue. ' +
                'This is recommended but not required.'
              );
            }

            // Check for @ mentions in PR description
            const mentionPattern = /@[\w-]+/;
            if (mentionPattern.test(body)) {
              core.setFailed(
                'PR description contains @ mentions. Please remove @ mentions as they ' +
                'make it into the commit message and notify users on every push.'
              );
            }
